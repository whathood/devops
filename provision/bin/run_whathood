#!/usr/bin/env ruby

# RUN AS: vagrant

# Build the docker containers required by Whathood from whathood-devops

home = ENV['HOME']
user = ENV['USER']

devops_dir = "#{home}/src/wh-devops"

puts "*      cloning whathood devops"

cmds = [
  # required for when adding a mapped drive from vagrant
  "echo \"whoami is: \" `whoami`",
  "echo \"home is: \" #{home}",

  # if Vagrantfile is not creating a source file, you'll need to do it
  "sudo mkdir -p #{home}/src",
  "sudo chown -R vagrant #{home}/src",

  # try to clone wh-devops
  "git clone https://github.com/whathood/wh-devops.git #{devops_dir} || true",
  "sudo chown vagrant.vagrant -R #{home}"
]

cmds.each {|cmd|
  puts cmd
  unless system "#{cmd} >&2"
    abort "could not execute cmd '#{cmd}'"
  end
}

Dir.chdir devops_dir

cmds = [
  #"git checkout -b develop || git checkout develop",
  #"git pull origin develop",
  "cp /vagrant/provision/config/config.local.yaml #{devops_dir}",
  "cp /vagrant/provision/config/whathood.local.yaml #{devops_dir} || true"
]

cmds.each {|cmd|
  puts cmd
  unless system "#{cmd} >&2"
    abort "could not execute cmd '#{cmd}'"
  end
}

Dir.chdir devops_dir

# don't sudo or the root user will own the git repo
cmd = './bin/setup'
puts cmd
system cmd
